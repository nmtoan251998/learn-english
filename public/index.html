<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Welcome to Firebase Hosting</title>

    <!-- update the version number as needed -->
    <script defer src="/__/firebase/5.4.0/firebase-app.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/5.4.0/firebase-auth.js"></script>
    <script defer src="/__/firebase/5.4.0/firebase-database.js"></script>
    <script defer src="/__/firebase/5.4.0/firebase-messaging.js"></script>
    <script defer src="/__/firebase/5.4.0/firebase-storage.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/5.4.0/firebase-app.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/5.4.0/firebase-firestore.js"></script>
    <!-- initialize the SDK after all desired features are loaded -->
    <script defer src="/__/firebase/init.js"></script>
  </head>
  <body>
    <h2>Add module</h2>
      Word:<br/><input type="text" name="new vocabulary inputed" id="input-vocab"><br/>
      Meaning:<br/><input type="text" name="vocabulary meaning" id="input-meaning"><br/>
      Form:<br/><input type="text" name="vocabulary form" id="input-form">
      <button id="btn-add">Add</button>
      <button id="btn-clear-local">Clear</button>
    <h2>Show module</h2>
      <ol id="my-fucking-list">
        <!-- <li></li> -->
      </ol>
      <button id="btn-show-all">Show All</button><br/><br/>
      <br/>Pick a date<br/>
      <input type="date" name="showdata-date" id="input-get-date" data-date="" data-date-format="DD/MM/YYYY"><br/>
      <button id="btn-show-each">Show</button>

  
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        /*

        // Better performance: 
        1.We need to store the recent count to localStorage if the date does not change to synchronize the database (addDb module) --> done
          1.1.Due to 1, we have to change the checking existence conditions of a particular word (word -> verb form -> meaning)
        2.We need to restruct the database structure --> done
          2.1.We should store data into date/content-x (x is increasing due to the number of inputed time) --> field {word: x, meaning: y} for better performance
          2.2.We should restruct the data structure again by adding 'verb form' into the database, because we have 
              a ton of similar vocabulary in English (program (n): chương trình, program (v): lập trình)
          2.3.Due to the changes in (2.2), we have to build another textBox of which value is verb-form
        3.Do we have to store the inputed meaning to adminDb? --> done 



        4.NEWEST -> How to write an synchronous CheckExist() --> done. using pronmise
        5.Convert textField onto form->input to use 'required' of HTML (Check users to fill out the textfield)
        6. Write function capitilize word, eg: nguyen minh toan -> Nguyen Minh Toan --> done
        7. Make ShowAll Module

        

        //Is doings
        1. Try to write checkForm(form) function to prevent the isolated switch-case function --> done
        2. Try to write data into CheckDb -> array (adj, noun, .....) --> done
        3.Convert textField onto form->input to use 'required' of HTML (Check users to fill out the textfield) -> waiting
        4. Make showAll module
        
        
      
       
        

        ====================================================================  */
        
        //initialize the firebase var
        var db = firebase.firestore();

        /*get id of HTML elements*/
        var txtNewVocab = document.getElementById('input-vocab');
        var txtVocabMeaning =  document.getElementById('input-meaning');
        var txtVocabForm = document.getElementById('input-form');
        var dateShowData = document.getElementById('input-get-date');

        var btnAdd = document.getElementById('btn-add');
        var btnClearLocal = document.getElementById('btn-clear-local');
        var btnShowAll = document.getElementById('btn-show-all');
        var btnShowEach = document.getElementById('btn-show-each');

        var myHTMLList = document.getElementById('my-fucking-list');

        /*receive values of textField*/
        let word = toUpperEach(txtNewVocab.value);
        let meaning = toUpperEach(txtVocabMeaning.value);
        let form = toUpperEach(txtVocabForm.value);

        //add into local storage for the first time
        const localKey = 'inputCounter';
        //counter is stored into localStorage
        let count = 0;

        /*addEventListeners*/
        btnAdd.addEventListener("click", addNewVocab);
        btnClearLocal.addEventListener("click", function(){
          localStorage.setItem(localKey, 0);
          count = localStorage.getItem(localKey);  
        });
        // btnShowAll.addEventListener('click', showAll);
        btnShowEach.addEventListener('click', showEach);


        //METHODS ARE GONE HERE
        /*====================================================================*/

        //add to the database
        function addNewVocab(){
          /*receive values of textField*/
          let word = toUpperEach(txtNewVocab.value);
          let meaning = toUpperEach(txtVocabMeaning.value);
          let form = toUpperEach(txtVocabForm.value);

          //get the recent date
          dailyObj = new Date();
          //receive the recent day-month-year
          let getDate = dateToString(dailyObj);

          //get the recent count inputed
          count = localStorage.getItem(localKey);

          //stored place
          var anotherVocab = `vocab${count}`;

          /*get database Paths*/
          //Client database path
          let clientPath = db.collection('ClientDb').doc(getDate).collection(anotherVocab).doc('content');
          //CheckPath
          let checkPath = db.doc('CheckDb/vocabForm');

          //check the existence of particular words in the database
          let checker = false;
          //variable to get data from the CheckDb
          let getWord;

          //check the inputed vocabulary form (noun-adjective-adverb-verb)
          checkPath.get()
          .then(doc => {
            if(form === 'Adjective')
              getWord = doc.data().adjective;
            else if(form === 'Adverb')
              getWord = doc.data().adverb;
            else if(form === 'Noun')
              getWord = doc.data().noun;
            else if(form === 'Verb')
              getWord = doc.data().verb;

            return getWord;
          })
          .then(getWord =>  {
            //make comparison between recent inputed word - database
            getWord.map(getEach => {
              if(word === getEach){
                //if the word does exist, turn checker to true
                checker = true;
              }
            });      
            return checker;
          })
          .then(checker => {
            //if the checker is true, users cannot input the word 
            if(checker === true) {
              return alert('this word does exist in your storage, please re-enter new word');
            }
            else{
              //add new data to the db
              db.doc('ClientDb/' +getDate).set({
                dummie: 'dummie'
              })
              .then(function(){
                //add new data to the db
                clientPath.set({
                  form: form,
                  meaning: meaning,
                  word: word
                });
              })
              .then(function(){
                alert('Added successfully!');
                //if successfull added, increase the recent index of data in the database
                count++;
                //write it to the localStorage
                localStorage.setItem(localKey, count);

                //update the data in TestDb
                db.collection('TestDb').doc("bank").update({
                  meaning: firebase.firestore.FieldValue.arrayUnion(meaning)
                })
                .then(function(){
                  //update the CheckDb with new word
                  if(form === 'Adjective')
                    db.collection('CheckDb').doc('vocabForm').update({
                      adjective: firebase.firestore.FieldValue.arrayUnion(word)
                    });
                  else if(form === 'Adverb')
                    db.collection('CheckDb').doc('vocabForm').update({
                      adverb: firebase.firestore.FieldValue.arrayUnion(word)
                    });
                  else if(form === 'Noun')
                    db.collection('CheckDb').doc('vocabForm').update({
                      noun: firebase.firestore.FieldValue.arrayUnion(word)
                    });
                  else if(form === 'Verb')
                    db.collection('CheckDb').doc('vocabForm').update({
                      verb: firebase.firestore.FieldValue.arrayUnion(word)
                    });
                });
              })
              .then(function(){
                //clear the textBox after inputed
                txtNewVocab.value = "";
                txtVocabMeaning.value = "";
                txtVocabForm.value = "";
              })
              .catch(error => error)
            } //end of else
          })
          .catch(error => console.log(error))
        }

        //convert date to toString()
        function dateToString(dateObj){
          //get date properties
          let year = dateObj.getFullYear(); //get the year from dailyObj
          let month = dateObj.getMonth() + 1; //get the month from dailyObj (1-->12)
          let day = dateObj.getDate()-10; //get date from the dailyObj
          let date = day +"-" +month +"-" +year;
          //parse date into string
          toString(date);
          return date;
        }

        //capitalize word
        function toUpperEach(string) {
          return string
            .trim()
            .toLowerCase()
            .split(' ')
            .map(word => word.substr(0,1).toUpperCase() + word.substr(1, word.length))
            .join(' ')
        };

        /*============================================================*/
        //SHOW MODULE
        let myDataList = [];

        //show data by date
        function showEach(){
        //receive the date to show data in that date
        let getDate = dateShowData.value
        let dateReceiver = "21-8-2018";

        db.collection('ClientDb').get()
          .then((doc) => {
            console.log('length: ' +doc.docs.length);
            // if(!doc.exists) return alert("You didn't input any shit in this day, you mother fucker");
            //   console.log(doc.data());

          })
          .catch(error => console.log(error))
        }

        // //show all database into website
        // function showAll(){

        //   db.collection('ClientDb').get()
        //     .then(query => {
        //       for(let i = 0; i < query.size; i++)
        //         console.log(query);
        //     })
        // }

        //render





      }); //end of DOM.contentLoaded
    </script>

  </body>
</html>